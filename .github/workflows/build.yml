name: Compilació i Manuals

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    permissions:
      contents: write  # Crucial per poder crear la Release

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instal·la eines
        run: pip install pyinstaller markdown

      # SECCIÓ LINUX
      - name: Build Linux i HTML
        if: runner.os == 'Linux'
        run: |
          mkdir -p dist_final

          # Creem l'script convertidor directament en un fitxer
          echo "import markdown, sys" > convert.py
          echo "with open(sys.argv[1], 'r', encoding='utf-8') as f: body = markdown.markdown(f.read(), extensions=['extra', 'tables'])" >> convert.py
          echo "with open(sys.argv[2], 'w', encoding='utf-8') as f: f.write(f'<html><body>{body}</body></html>')" >> convert.py

          # Bucle simplificat
          for d in */; do
            dir=${d%/}
            [ -d "$dir/source" ] || [ -d "$dir/Source" ] || continue

            # Nom del programa
            name=$(echo "$dir" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

            # Trobar el .py principal
            py_path=$(find "$dir" -name "*.py" | head -n1)

            # Compilar
            pyinstaller --onefile --name "$name" --distpath "./dist_final" "$py_path"

            # Manual (busquem manual.md dins de la carpeta del programa)
            if [ -f "$dir/manual.md" ]; then
              python3 convert.py "$dir/manual.md" "dist_final/${name}_manual.html"
            elif [ -f "$dir/MANUAL.md" ]; then
              python3 convert.py "$dir/MANUAL.md" "dist_final/${name}_manual.html"
            fi
          done

      # SECCIÓ WINDOWS
      - name: Build Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -Path "dist_final" -ItemType Directory -Force
          Get-ChildItem -Directory | ForEach-Object {
            $src = if (Test-Path "$($_.Name)/source") { "$($_.Name)/source" } else { "$($_.Name)/Source" }
            if (Test-Path $src) {
              $exeName = $_.Name.ToLower() -replace ' ', '-'
              $pyFile = Get-ChildItem "$src/*.py" | Select-Object -First 1
              if ($pyFile) {
                pyinstaller --onefile --name $exeName --distpath "dist_final" $pyFile.FullName
              }
            }
          }

      - name: Publicar Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist_final/*
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
