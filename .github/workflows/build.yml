name: Compilació multiplataforma

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: windows

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instal·la dependències
        run: pip install pyinstaller markdown

      - name: Compila i genera Manual (Linux)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          mkdir -p dist_linux

          # Creem un script de python extern per evitar errors de YAML
          cat << 'EOF' > convert_md.py
          import markdown, sys
          import os
          def convert(md_path, html_path):
              with open(md_path, 'r', encoding='utf-8') as f:
                  body = markdown.markdown(f.read(), extensions=['extra', 'tables', 'fenced_code'])
              with open(html_path, 'w', encoding='utf-8') as f:
                  f.write(f'<html><body style="font-family:sans-serif;max-width:800px;margin:auto;padding:2em">{body}</body></html>')
          if __name__ == "__main__":
              convert(sys.argv[1], sys.argv[2])
          EOF

          for dir in */; do
            dir="${dir%/}"
            [[ "$dir" =~ ^(\.github|\.git|assets|docs)$ ]] && continue

            src_dir=""
            [ -d "$dir/source" ] && src_dir="$dir/source"
            [ -d "$dir/Source" ] && src_dir="$dir/Source"
            [ -z "$src_dir" ] && continue

            exe_name=$(echo "$dir" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr '_' '-')
            py_file=$(find "$src_dir" -maxdepth 1 -name "*.py" | head -n1)
            [ -z "$py_file" ] && continue

            # Compilació
            pyinstaller --onefile --clean --name "$exe_name" --distpath "./dist_linux" --log-level=WARN "$py_file"

            # Generació de Manual HTML
            for m_file in "$dir/MANUAL.md" "$dir/MANUAL_US.md"; do
              if [ -f "$m_file" ]; then
                echo "Convertint $m_file..."
                python3 convert_md.py "$m_file" "dist_linux/${exe_name}_MANUAL.html"
                break
              fi
            done
          done

      - name: Compila (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          New-Item -Path "dist_windows" -ItemType Directory -Force
          Get-ChildItem -Directory | ForEach-Object {
            $name = $_.Name
            if ($name -in @(".github", ".git", "assets", "docs")) { return }
            $src = if (Test-Path "$name/source") { "$name/source" } else { "$name/Source" }
            if (-not (Test-Path $src)) { return }
            $exe = $name.ToLower() -replace ' ', '-' -replace '_', '-'
            $py = Get-ChildItem "$src/*.py" | Select-Object -First 1
            if (-not $py) { return }
            pyinstaller --onefile --clean --name $exe --distpath "dist_windows" --log-level=WARN $py.FullName
          }

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist_linux/*
            dist_windows/*.exe
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
