name: Compilaci贸 multiplataforma

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # JOB 1: Compilaci贸 a Linux i Generaci贸 de Manuals TXT
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Instal路la PyInstaller
        run: pip install pyinstaller
      - name: Compila Linux i cerca Manuals
        run: |
          mkdir -p dist_all
          for carpeta in */; do
            carpeta="${carpeta%/}"
            # Ignorar carpetes especials de GitHub/Git
            [[ "$carpeta" =~ ^(\.github|\.git|assets|docs)$ ]] && continue

            # 1. Detectar directori source (source o Source)
            if [[ -d "${carpeta}/source" ]]; then src="${carpeta}/source"
            elif [[ -d "${carpeta}/Source" ]]; then src="${carpeta}/Source"
            else continue; fi

            # Nom de l'executable (min煤scules i guions)
            nom_exe=$(echo "$carpeta" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr '_' '-')
            fitxer_py=$(find "$src" -maxdepth 1 -name "*.py" -type f | head -n1)
            [[ -z "$fitxer_py" ]] && continue

            # 2. Compilar l'executable de Linux
            echo " Compilant Linux: $nom_exe"
            cd "$src"
            pyinstaller --onefile "$(basename "$fitxer_py")" --name "$nom_exe" --distpath "../../dist_all" --log-level=WARN
            cd ../..

            # 3. Cercar el manual (a la carpeta del programa o a source)
            # El parmetre -iname fa que no importin maj煤scules/min煤scules
            manual_trobat=$(find "$carpeta" -maxdepth 2 -iname "manual.md" | head -n1)

            if [[ ! -z "$manual_trobat" ]]; then
              echo " Manual trobat a: $manual_trobat -> dist_all/${nom_exe}_manual.txt"
              cp "$manual_trobat" "dist_all/${nom_exe}_manual.txt"
            else
              echo "锔 No s'ha trobat cap manual per a $carpeta"
            fi
          done
      - name: Pujar Artifacts Linux
        uses: actions/upload-artifact@v4
        with:
          name: linux-assets
          path: dist_all/

  # JOB 2: Compilaci贸 a Windows
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Instal路la PyInstaller
        run: pip install pyinstaller
      - name: Compila Windows
        shell: pwsh
        run: |
          New-Item -Path "dist_all" -ItemType Directory -Force
          Get-ChildItem -Directory | ForEach-Object {
            $cap = $_.Name
            if ($cap -in @(".github", ".git", "assets", "docs")) { return }

            $src = if (Test-Path "$cap/source") { "$cap/source" } else { "$cap/Source" }
            if (-not (Test-Path $src)) { return }

            $exe = $cap.ToLower() -replace ' ', '-' -replace '_', '-'
            $py = Get-ChildItem "$src/*.py" | Select-Object -First 1
            if ($py) {
              Write-Host " Compilant Windows: $exe"
              Set-Location $src
              pyinstaller --onefile $py.Name --name $exe --distpath "..\..\dist_all" --log-level=WARN
              Set-Location ..\..
            }
          }
      - name: Pujar Artifacts Windows
        uses: actions/upload-artifact@v4
        with:
          name: windows-assets
          path: dist_all/

  # JOB 3: Publicaci贸 final de tots els fitxers a la Release
  publish:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows]
    steps:
      - name: Baixar tots els fitxers compilats
        uses: actions/download-artifact@v4
        with:
          path: release_files
          merge-multiple: true
      - name: Crear Release i pujar fitxers
        uses: softprops/action-gh-release@v2
        with:
          files: release_files/*
          tag_name: ${{ github.ref_name }}
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
