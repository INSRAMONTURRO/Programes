name: Compilació multiplataforma

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instal·la PyInstaller
        run: pip install pyinstaller

      - name: Compila i genera Manuals TXT (Linux)
        run: |
          mkdir -p dist_linux
          for carpeta in */; do
            carpeta="${carpeta%/}"
            [[ "$carpeta" =~ ^(\.github|\.git|assets|docs)$ ]] && continue
            if [[ -d "${carpeta}/source" ]]; then src="${carpeta}/source"
            elif [[ -d "${carpeta}/Source" ]]; then src="${carpeta}/Source"
            else continue; fi
            nom_exe=$(echo "$carpeta" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr '_' '-')
            fitxer_py=$(find "$src" -maxdepth 1 -name "*.py" -type f | head -n1)
            [[ -z "$fitxer_py" ]] && continue
            cd "$src"
            pyinstaller --onefile "$(basename "$fitxer_py")" --name "$nom_exe" --distpath "../../dist_linux" --log-level=WARN
            cd ../..
            if [[ -f "${carpeta}/manual.md" ]]; then
              cp "${carpeta}/manual.md" "dist_linux/${nom_exe}_manual.txt"
            elif [[ -f "${carpeta}/MANUAL.md" ]]; then
              cp "${carpeta}/MANUAL.md" "dist_linux/${nom_exe}_manual.txt"
            fi
          done
        shell: bash

      - name: Puja a Release (Linux)
        uses: softprops/action-gh-release@v2
        with:
          files: dist_linux/*
          tag_name: ${{ github.ref_name }}
          overwrite_files: true  # Paràmetre corregit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    runs-on: windows-latest
    needs: build-linux  # Espera que Linux acabi per no col·lisionar
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instal·la PyInstaller
        run: pip install pyinstaller

      - name: Compila (Windows)
        run: |
          New-Item -Path "dist_windows" -ItemType Directory -Force
          Get-ChildItem -Directory | ForEach-Object {
            $cap = $_.Name
            if ($cap -in @(".github", ".git", "assets", "docs")) { return }
            $src = if (Test-Path "$cap/source") { "$cap/source" } else { "$cap/Source" }
            if (-not (Test-Path $src)) { return }
            $exe = $cap.ToLower() -replace ' ', '-' -replace '_', '-'
            $py = Get-ChildItem "$src/*.py" | Select-Object -First 1
            if (-not $py) { return }
            Set-Location $src
            pyinstaller --onefile $py.Name --name $exe --distpath "..\..\dist_windows" --log-level=WARN
            Set-Location ..\..
          }
        shell: pwsh

      - name: Puja a Release (Windows)
        uses: softprops/action-gh-release@v2
        with:
          files: dist_windows/*.exe
          tag_name: ${{ github.ref_name }}
          overwrite_files: true  # Paràmetre corregit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
